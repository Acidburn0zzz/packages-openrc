# Maintainer: udeved <udeved@openrc4arch.site40.net>
# Contributor: Tom Gundersen <teg@jklm.no>
# Contributor: Jan de Groot <jgc@archlinux.org>
# Contributor: Link Dupont <link@subpop.net>
#

_gentoo_uri="http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/sys-apps/dbus/files"

pkgname=dbus-openrc
pkgver=1.6.12
pkgrel=1
pkgdesc="Freedesktop.org message bus system"
url="http://www.freedesktop.org/Software/dbus"
arch=(i686 x86_64)
license=('GPL' 'custom')
groups=('openrc-desktop')
# do not depend on systemd to avoid circular dep,
# dep on shadow for install scriptlet FS#29341
depends=('expat' 'coreutils' 'filesystem' 'shadow')
makedepends=('libx11')
optdepends=('libx11: dbus-launch support')
provides=('dbus-core' 'dbus')
conflicts=('dbus-core' 'dbus')
options=(!libtool)
install=dbus.install
source=("http://dbus.freedesktop.org/releases/dbus/dbus-$pkgver.tar.gz"
		"${_gentoo_uri}/dbus.initd" 
		"${_gentoo_uri}/80-dbus")

build() {
  cd dbus-$pkgver
  ./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--libexecdir=/usr/lib/dbus-1.0 \
		--with-dbus-user=dbus \
		--with-system-pid-file=/run/dbus/pid \
		--with-system-socket=/run/dbus/system_bus_socket \
		--with-console-auth-dir=/run/console/ \
		--enable-inotify \
		--disable-dnotify \
		--disable-verbose-mode \
		--disable-static \
		--disable-tests \
		--disable-asserts \
		--disable-systemd

  make
}

package(){
	cd $_rn-$pkgver
	make DESTDIR="$pkgdir" install

	rm -rf "$pkgdir/var/run"
	
	install -Dm755 "$srcdir/dbus.initd" "$pkgdir/etc/init.d/dbus"
	
	sed -e 's|dbus.pid|dbus/pid|g' -e 's|/var/run|/run|g' -i "$pkgdir/etc/init.d/dbus"

	install -Dm755 "$srcdir/80-dbus" "$pkgdir/etc/X11/xinit/xinitrc.d/80-dbus"

	install -Dm644 COPYING "$pkgdir/usr/share/licenses/dbus/COPYING"
}
sha256sums=('f67a7abfd6d045c1e9eba2bba4199d301836bc0c6e8a727c765913aba780ee92'
            '98e37b8b6ed25004e48c5855d74c9361eea06d3fee13cefcc0ed10ccf452aa01'
            '76ce25ce8769cdfcb0d7b7e52e5a7e6474448fc34e8ad9393afac1eca1e07fd2')
