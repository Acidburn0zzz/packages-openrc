# $Id: PKGBUILD 158661 2012-05-05 22:14:03Z eric $
# Maintainer: Eric BÃ©langer <eric@archlinux.org>

_pn=openrc-init-scripts
_rn=sysklogd
_pv=0.9.4

pkgname=$_rn-openrc
pkgver=1.5
pkgrel=1
pkgdesc="System and kernel log daemons"
arch=('i686' 'x86_64')
url="http://www.infodrom.org/projects/sysklogd/"
license=('GPL' 'BSD')
depends=('glibc' 'bash' 'openrc')
provides=('logger')
backup=('etc/syslog.conf' 'etc/logrotate.d/syslog')
source=("http://www.infodrom.org/projects/sysklogd/download/${_rn}-${pkgver}.tar.gz"
        'sysklogd-1.4.1-caen-owl-syslogd-bind.diff'
        'sysklogd-1.4.1-caen-owl-syslogd-drop-root.diff'
        'sysklogd-1.4.1-caen-owl-klogd-drop-root.diff'
        'sysklogd-1.5-syslog-func-collision.patch'
        "http://openrc4arch.site40.net/pool/archlinux/$_pn-$_pv.tar.xz"
        'syslog.conf' 'syslog.logrotate' 'LICENSE')

build() {
  cd "${srcdir}/${_rn}-${pkgver}"
# CAEN/OWL security patches
  patch -p1 -i ../sysklogd-1.4.1-caen-owl-syslogd-bind.diff
  patch -p1 -i ../sysklogd-1.4.1-caen-owl-syslogd-drop-root.diff 
  patch -p1 -i ../sysklogd-1.4.1-caen-owl-klogd-drop-root.diff

  patch -p1 -i ../sysklogd-1.5-syslog-func-collision.patch
  sed -i -e "s/-O3/${CFLAGS} -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE/" \
         -e "s/LDFLAGS= -s/LDFLAGS= ${LDFLAGS}/" Makefile
  sed -i 's/500 -s/755/' Makefile
  make
}

package() {
	cd "${srcdir}/${_rn}-${pkgver}"
	install -d "${pkgdir}/usr/sbin" "${pkgdir}"/usr/share/man/{man5,man8}
 
	make prefix="${pkgdir}" install
  
	install -D -m644 ../syslog.conf "${pkgdir}/etc/syslog.conf"
	install -D -m644 ../syslog.logrotate "${pkgdir}/etc/logrotate.d/syslog"

	install -D -m644 ../LICENSE "${pkgdir}/usr/share/licenses/${_rn}/LICENSE"
  
	install -Dm755 "$srcdir/$_pn/$_rn/conf.d/sysklogd.confd" "$pkgdir/etc/conf.d/$_rn"
	install -Dm755 "$srcdir/$_pn/$_rn/init.d/sysklogd.rc7" "$pkgdir/etc/init.d/$_rn"	
  
}
