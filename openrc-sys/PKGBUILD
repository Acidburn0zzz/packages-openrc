# Maintainer: udeved <udeved@openrc4arch.site40.net>

pkgbase=openrc-sys
pkgname=openrc-sys
true && pkgname=('acpid-openrc' 'cpupower-openrc' 'cronie-openrc'
		'cryptsetup-openrc' 'dbus-openrc' 'device-mapper-openrc'
		'glibc-openrc' 'lm_sensors-openrc' 'lvm2-openrc'
		'mdadm-openrc' 'syslog-ng-openrc')
pkgver=20131016
pkgrel=1
pkgdesc="OpenRC init scripts"
arch=('any')
url="http://openrc4arch.site40.net"
license=('GPL2')
groups=('openrc-sys')
makedepends=('acpid' 'cpupower' 'cronie' 'cryptsetup' 'dbus'
	    'device-mapper' 'glibc' 'lm_sensors' 'lvm2'
	    'mdadm' 'syslog-ng')
conflicts=('openrc-arch-services-git')

_gentoo_uri="http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86"

source=("${_gentoo_uri}/sys-power/acpid/files/acpid-2.0.16-conf.d"
	"${_gentoo_uri}/sys-power/acpid/files/acpid-2.0.16-init.d"
	"${_gentoo_uri}/sys-power/cpupower/files/conf.d-r2"
	"${_gentoo_uri}/sys-power/cpupower/files/init.d-r2"
	"${_gentoo_uri}/sys-process/cronie/files/cronie-1.3-initd"
	"${_gentoo_uri}/sys-process/cronie/files/anacron-1.0-initd"
	"${_gentoo_uri}/sys-fs/cryptsetup/files/1.0.6-dmcrypt.confd"
	"${_gentoo_uri}/sys-fs/cryptsetup/files/1.5.1-dmcrypt.rc"
	"${_gentoo_uri}/sys-apps/dbus/files/dbus.initd"
	"${_gentoo_uri}/sys-libs/glibc/files/nscd"
	"${_gentoo_uri}/sys-apps/lm_sensors/files/sensord-conf.d"
	"${_gentoo_uri}/sys-apps/lm_sensors/files/sensord-4-init.d"
	"${_gentoo_uri}/sys-apps/lm_sensors/files/fancontrol-init.d-2"
	"${_gentoo_uri}/sys-apps/lm_sensors/files/lm_sensors-3-init.d"
	"${_gentoo_uri}/sys-fs/lvm2/files/device-mapper.conf-1.02.22-r3"
	"${_gentoo_uri}/sys-fs/lvm2/files/device-mapper.rc-2.02.95-r2"
	"${_gentoo_uri}/sys-fs/lvm2/files/dmeventd.initd-2.02.67-r1"
	"${_gentoo_uri}/sys-fs/lvm2/files/lvm.confd-2.02.28-r2"
	"${_gentoo_uri}/sys-fs/lvm2/files/lvm.rc-2.02.95-r2"
	"${_gentoo_uri}/sys-fs/lvm2/files/lvm-monitoring.initd-2.02.67-r2"
	"${_gentoo_uri}/sys-fs/mdadm/files/mdadm.confd"
	"${_gentoo_uri}/sys-fs/mdadm/files/mdadm.rc"
	"${_gentoo_uri}/app-admin/syslog-ng/files/syslog-ng.confd"
	"${_gentoo_uri}/app-admin/syslog-ng/files/syslog-ng.rc6.3.3")


pkgver() {
  date +%Y%m%d
}

_shebang='s|#!/sbin/runscript|#!/usr/bin/runscript|'
_runpath='s|/var/run|/run|g'
_binpath='s|/usr/sbin|/usr/bin|g'
_binpath2='s|/sbin|/usr/bin|g'

package_acpid-openrc() {
	true
	pkgdesc="OpenRC acpid init script"
	depends=('openrc-base' 'acpid')
	install=acpid.install

	install -Dm755 "${srcdir}/acpid-2.0.16-conf.d" "${pkgdir}/etc/conf.d/acpid"
	install -Dm755 "${srcdir}/acpid-2.0.16-init.d" "${pkgdir}/etc/init.d/acpid"

	sed -e "${_shebang}" -e "${_binpath}" -i "${pkgdir}/etc/init.d/acpid"
}

package_cpupower-openrc() {
	true
	pkgdesc="OpenRC cpupower init script"
	depends=('openrc-base' 'cpupower')
	install=cpupower.install

	install -Dm755 "${srcdir}/conf.d-r2" "${pkgdir}/etc/conf.d/cpupower"
	install -Dm755 "${srcdir}/init.d-r2" "${pkgdir}/etc/init.d/cpupower"

	sed -e "${_shebang}" -i "${pkgdir}/etc/init.d/cpupower"
}

package_cronie-openrc() {
	true
	pkgdesc="OpenRC cronie init script"
	depends=('openrc-base' 'cronie')
	provides=('openrc-cron')
	conflicts=('openrc-cron')
	install=cronie.install

	install -Dm755 "${srcdir}/cronie-1.3-initd" "${pkgdir}/etc/init.d/cronie"
	install -Dm755 "${srcdir}/anacron-1.0-initd" "${pkgdir}/etc/init.d/anacron"

	for f in ${pkgdir}/etc/init.d/*;
	do
	  sed -e "${_shebang}" -e "${_binpath}" -e "${_runpath}" -i $f
	done
}

package_cryptsetup-openrc() {
	true
	pkgdesc="OpenRC cryptsetup init script"
	depends=('openrc-base' 'cryptsetup')
	install=cryptsetup.install

	install -Dm755 "${srcdir}/1.0.6-dmcrypt.confd" "${pkgdir}/etc/conf.d/dmcrypt"
	install -Dm755 "${srcdir}/1.5.1-dmcrypt.rc" "${pkgdir}/etc/init.d/dmcrypt"

	sed -e "${_shebang}" -e "${_binpath}" -e "${_runpath}" -i ${pkgdir}/etc/init.d/dmcrypt
}

package_dbus-openrc() {
	true
	pkgdesc="OpenRC dbus init script"
	depends=('openrc-base' 'dbus')
	install=dbus.install

	install -Dm755 "${srcdir}/dbus.initd" "${pkgdir}/etc/init.d/dbus"

	local _p1='s|dbus.pid|dbus/pid|g'
	sed -e "${_shebang}" -e "${_runpath}" -e "${_p1}" -i "${pkgdir}/etc/init.d/dbus"
}

package_device-mapper-openrc() {
	true
	pkgdesc="OpenRC device-mapper init script"
	depends=('openrc-base' 'device-mapper')
	install=device-mapper.install

	install -Dm755 "${srcdir}/device-mapper.conf-1.02.22-r3" "${pkgdir}/etc/conf.d/device-mapper"
	install -Dm755 "${srcdir}/device-mapper.rc-2.02.95-r2" "${pkgdir}/etc/init.d/device-mapper"
	install -Dm755 "${srcdir}/dmeventd.initd-2.02.67-r1" "${pkgdir}/etc/init.d/dmeventd"

	for f in ${pkgdir}/etc/init.d/*;
	do
	  sed -e "${_shebang}" -e "${_binpath2}" -e "${_runpath}" -i $f
	done
}

package_glibc-openrc() {
	true
	pkgdesc="OpenRC nscd init script"
	depends=('openrc-base' 'glibc')
	optdepends=('openldap-openrc' 'bind-openrc')
	install=glibc.install

	install -Dm755 "${srcdir}/nscd" "${pkgdir}/etc/init.d/nscd"

	sed -e "${_shebang}" -e "${_binpath}" -e "${_runpath}" -i "${pkgdir}/etc/init.d/nscd"
}

package_lm_sensors-openrc() {
	true
	pkgdesc="OpenRC lm_sensors init script"
	depends=('openrc-base' 'lm_sensors')
	install=lm_sensors.install

	install -Dm755 "${srcdir}/sensord-conf.d" "${pkgdir}/etc/conf.d/sensord"
	install -Dm755 "${srcdir}/sensord-4-init.d" "${pkgdir}/etc/init.d/sensord"
	install -Dm755 "${srcdir}/fancontrol-init.d-2" "${pkgdir}/etc/init.d/fancontrol"
	install -Dm755 "${srcdir}/lm_sensors-3-init.d" "${pkgdir}/etc/init.d/lm_sensors"

	for f in ${pkgdir}/etc/init.d/*;
	do
	  sed -e "${_shebang}" -e "${_binpath}" -e "${_runpath}" -i $f
	done
}

package_lvm2-openrc() {
	true
	pkgdesc="OpenRC lvm2 init script"
	depends=('openrc-base' 'lvm2' 'device-mapper-openrc')
	install=lvm2.install

	install -Dm755 "${srcdir}/lvm.confd-2.02.28-r2" "${pkgdir}/etc/conf.d/lvm"
	install -Dm755 "${srcdir}/lvm.rc-2.02.95-r2" "${pkgdir}/etc/init.d/lvm"
	install -Dm755 "${srcdir}/lvm-monitoring.initd-2.02.67-r2" "${pkgdir}/etc/init.d/lvm-monitoring"

	for f in ${pkgdir}/etc/init.d/*;
	do
	  sed -e "${_shebang}" -e "${_binpath2}" -e "${_runpath}" -i $f
	done
}

package_mdadm-openrc() {
	true
	pkgdesc="OpenRC mdadm init script"
	depends=('openrc-base' 'mdadm')
	optdepends=('bind-openrc')
	install=mdadm.install

	install -Dm755 "${srcdir}/mdadm.confd" "${pkgdir}/etc/conf.d/mdadm"
	install -Dm755 "${srcdir}/mdadm.rc" "${pkgdir}/etc/init.d/mdadm"

	sed -e "${_shebang}" -e "${_runpath}" -i ${pkgdir}/etc/init.d/mdadm
}

package_syslog-ng-openrc() {
	true
	pkgdesc="OpenRC syslog-ng init script"
	depends=('openrc-base' 'syslog-ng')
	install=syslog-ng.install

	install -Dm755 "${srcdir}/syslog-ng.confd" "${pkgdir}/etc/conf.d/syslog-ng"
	install -Dm755 "${srcdir}/syslog-ng.rc6.3.3" "${pkgdir}/etc/init.d/syslog-ng"

	sed -e "${_shebang}" -e "${_binpath}" -e "${_runpath}" -i ${pkgdir}/etc/init.d/syslog-ng
}
