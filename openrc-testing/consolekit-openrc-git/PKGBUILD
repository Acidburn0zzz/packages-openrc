# Maintainer: udeved <udeved@openrc4@openrc4arch.site40.net>
# Contributor: Lukas Jirkovsky <l.jirkovsky@gmail.com>
# Contributor: Jan de Groot <jgc@archlinux.org>
# Contributor: onestep_ua <onestep@ukr.net>

_pn=openrc-init-scripts
_rn=consolekit
_pv=0.9.4

pkgname=consolekit-openrc-git
pkgver=20130814
pkgrel=1
pkgdesc="A framework for defining and tracking users, login sessions, and seats"
arch=('i686' 'x86_64')
url="http://www.freedesktop.org/wiki/Software/ConsoleKit"
license=('GPL')
groups=('openrc-desktop')
depends=('polkit-consolekit' 'zlib' 'libx11' 'dbus-glib' 'dbus-openrc')
makedepends=('git' 'pkgconfig' 'xmlto' 'docbook-xsl')
replaces=('consolekit' 'consolekit-git')
provides=('consolekit')
conflicts=('consolekit' 'consolekit-openrc')
install=$_rn.install
options=(!libtool)
source=('pam-foreground-compat.ck'
		'consolekit.logrotate'
		'consolekit.tmpfiles.conf'
		"http://openrc4arch.site40.net/pool/archlinux/$_pn-$_pv.tar.xz"
		"http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/sys-auth/consolekit/files/90-consolekit-3")


_gitroot=git://anongit.freedesktop.org/ConsoleKit
_gitname=consolekit

build() {

  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]; then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"

  ./autogen.sh  \
		--prefix=/usr \
		--sysconfdir=/etc \
		--sbindir=/usr/bin \
		--localstatedir=/var \
		--libexecdir=/usr/lib/ConsoleKit \
		--enable-pam-module \
		--with-pam-module-dir=/usr/lib/security \
		--enable-docbook-docs \
		--enable-udev-acl
  make
}

package() {
  cd "$srcdir/$_gitname-build"
  make DESTDIR="$pkgdir" install
  install -m755 "$srcdir/pam-foreground-compat.ck" "$pkgdir/usr/lib/ConsoleKit/run-session.d/"

  # install the logrotate config
  install -D -m644 "$srcdir/consolekit.logrotate" "$pkgdir/etc/logrotate.d/consolekit"

  install -D -m644 "$srcdir/consolekit.tmpfiles.conf" "$pkgdir/usr/lib/tmpfiles.d/consolekit.conf"

  rm -rf "${pkgdir}/var/run"
  
  	install -Dm755 "$srcdir/$_pn/$_rn/init.d/consolekit-0.2.rc" "$pkgdir/etc/init.d/$_rn"
	install -Dm755 "$srcdir/90-consolekit-3" "$pkgdir/etc/X11/xinit/xinitrc.d/90-consolekit"
  
  
}

sha256sums=('351b71189ff51e396746625e121b34be2d1ba22714277720550dda09471bfcf1'
            '79735ddd37b8ce6216c78542c2a4e32692dce757c86ecd5771ea8a895a1e8e4d'
            '778552dc12b3c235bde200e476d4262da0c135f3f6f8b3e975a87881d1f154d1'
            '6f5a4b729200226363325d207d475216db4eb8d6e29075a170f5fc7a52943255'
            '91e0900995f7db536220065959d236fb75ec2c77096981a142e2e948518d9761')
