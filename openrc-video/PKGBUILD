# Maintainer: artoo <flower_of_life@gmx.net>

_gentoo_uri=http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86

_Cbumb=bumblebee.confd
_Ibumb=bumblebee.initd
_Inv=nvidia-smi.init
_Iati=atieventsd.init
_Cvgl=vgl.confd-r1
_Ivgl=vgl.initd-r2
_Svgl=vgl-helper.sh

pkgbase=openrc-video
pkgname=('nvidia-utils-openrc'
	'catalyst-utils-openrc'
	'virtualgl-openrc'
	'bumblebee-openrc')
pkgver=20141106
pkgrel=1
arch=('any')
url="https://github.com/udeved/pkgbuilds"
license=('GPL')
makedepends=('nvidia-utils'
	    'acpid-openrc' 
	    'catalyst-utils'
	    'virtualgl'
	    'bumblebee')
source=("${_gentoo_uri}/x11-drivers/nvidia-drivers/files/${_Inv}"
	"${_gentoo_uri}/x11-drivers/ati-drivers/files/${_Iati}"
	"${_gentoo_uri}/x11-misc/virtualgl/files/${_Cvgl}"
	"${_gentoo_uri}/x11-misc/virtualgl/files/${_Ivgl}"
	"${_gentoo_uri}/x11-misc/virtualgl/files/${_Svgl}"
	"${_gentoo_uri}/x11-misc/bumblebee/files/${_Cbumb}"
	"${_gentoo_uri}/x11-misc/bumblebee/files/${_Ibumb}")


pkgver() {
  date +%Y%m%d
}

_shebang='s|#!/sbin/runscript|#!/usr/bin/openrc-run|'

package_nvidia-utils-openrc() {
    pkgdesc="OpenRC nvidia-smi init script"
    depends=('openrc-core' 'nvidia-utils')
    install=nvidia-utils.install

    local _binpath='s|/opt/bin|/usr/bin|g'

    install -Dm755 "${srcdir}/${_Inv}" "${pkgdir}"/etc/init.d/nvidia-smi
    sed -e ${_shebang} -e ${_binpath} -i "${pkgdir}"/etc/init.d/nvidia-smi
}

package_catalyst-utils-openrc() {
    pkgdesc="OpenRC atieventsd init script"
    depends=('catalyst-utils' 'acpid-openrc')
    install=catalyst-utils.install
    backup=('etc/conf.d/atieventsd')
    
    local _binpath='s|/opt/sbin|/usr/bin|g'

    install -Dm755 "${srcdir}/${_Iati}" "${pkgdir}"/etc/init.d/atieventsd
    sed -e ${_shebang} -e ${_binpath} -i "${pkgdir}"/etc/init.d/atieventsd
    install -d "${pkgdir}"/etc/conf.d
    echo 'ATIEVENTSDOPTS=""' > "${pkgdir}"/etc/conf.d/atieventsd
}

package_virtualgl-openrc() {
    pkgdesc="OpenRC virtualgl init script"
    depends=('openrc-core' 'virtualgl')
    install=virtualgl.install
    backup=('etc/conf.d/vgl')

    install -Dm755 "${srcdir}/${_Cvgl}" "${pkgdir}"/etc/conf.d/vgl
    install -Dm755 "${srcdir}/${_Ivgl}" "${pkgdir}"/etc/init.d/vgl
    sed -e ${_shebang} -i "${pkgdir}"/etc/init.d/vgl
    install -Dm755 "${srcdir}/${_Svgl}" "${pkgdir}"/usr/lib/${_Svgl}
    install -d "${pkgdir}"/var/lib/VirtualGL
}

package_bumblebee-openrc() {
    pkgdesc="OpenRC bumblebee init script"
    depends=('virtualgl-openrc' 'bumblebee')
    install=bumblebee.install
    backup=('etc/conf.d/bumblebee')
    
    local _binpath='s|/usr/sbin|/usr/bin|g'
    local _runpath='s|/var/run|/run|g'
    install -Dm755 "${srcdir}/${_Cbumb}" "${pkgdir}"/etc/conf.d/bumblebee
    install -Dm755 "${srcdir}/${_Ibumb}" "${pkgdir}"/etc/init.d/bumblebee
    sed -e ${_shebang} -e ${_binpath} -e ${_runpath} -i "${pkgdir}"/etc/init.d/bumblebee
}

package() {
	pkgdesc="OpenRC virtualbox-guest-utils init script"
	depends=('openrc-core' 'virtualbox-guest-utils')
	install=virtualbox-guest-additions.install

	install -Dm755 "${srcdir}/${_Ivbox}" "${pkgdir}/etc/init.d/vboxservice"

	local _runpath='s|/var/run|/run|g'
	local _binpath='s|/sbin/|/usr/bin/|g'
	local _p1='s|vboxguest-service|VBoxService|g'

	sed -e "${_shebang}" -e "${_binpath}" -e "${_runpath}" -e "${_p1}" -i "${pkgdir}/etc/init.d/vboxservice"
}

